<!DOCTYPE html>
<HTML>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Grupo#6</title>
        <link rel="stylesheet" href="styles.css">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    </head>
    <body>

        <main>
            <div class="px-4 py-2 my-2 text-center border-bottom">
              <img class="d-block mx-auto mb-2" src="data:image/jpeg;base64,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" alt="" width="300" height="170">

              <h1 class="display-5 fw-bold">GALA IA</h1>
              <div class="col-lg-6 mx-auto">
                <p class="lead mb-0">Prediccion de numeros escritos a mano</p>
              </div>
            </div>

       
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
        


        <div class="b-example-divider"></div>

        <div class="container mt-5">
          <div class="row">
            <div class="col-12 col-md-4 offset-md-4">
              <div id="canvas-container">
                <div><i>.....! Dibuja Bien grande !</i></div>
                <canvas id="bigcanvas" width="200" height="200"></canvas>
                <canvas id="smallcanvas" width="28" height="28" style="display: none"></canvas>
              </div>
              <div class="text-center mt-3">
                <button class="btn btn-primary" id="limpiar" onclick="limpiar()">Limpiar</button>
                <button class="btn btn-success" id="predecir" onclick="predecir()">Predecir</button>
                <div id="resultado"></div>
              </div>
              
            </div>
          </div>
        </div>
  
        <div class="b-example-divider"></div>
  
  
        <div class="b-example-divider mb-0"></div>
      </main>
  
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  
      <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
      <script src="fabric.min.js"></script>
      <script src="drawing.js"></script>
  
      <script type="text/javascript">
  
        var modelo = null;
  
        //Tomar y configurar el canvas
        var canvas = document.getElementById("bigcanvas");
        var ctx1 = canvas.getContext("2d");
        var smallcanvas = document.getElementById("smallcanvas");
        var ctx2= smallcanvas.getContext("2d");
  
        function limpiar() {
            ctx1.clearRect(0, 0, canvas.width, canvas.height);
            drawingcanvas.clear();
        }
  
        function predecir() {
              //Pasar canvas a version 28x28
              resample_single(canvas, 28, 28, smallcanvas);
  
              var imgData = ctx2.getImageData(0,0,28,28);
              var arr = []; //El arreglo completo
              var arr28 = []; //Al llegar a 28 posiciones se pone en 'arr' como un nuevo indice
              for (var p=0, i=0; p < imgData.data.length; p+=4) {
                  var valor = imgData.data[p+3]/255;
                  arr28.push([valor]); //Agregar al arr28 y normalizar a 0-1. Aparte queda dentro de un arreglo en el indice 0... again
                  if (arr28.length == 28) {
                      arr.push(arr28);
                      arr28 = [];
                  }
              }
  
              arr = [arr]; //Meter el arreglo en otro arreglo por que si no tio tensorflow se enoja >:(
              //Nah basicamente Debe estar en un arreglo nuevo en el indice 0, por ser un tensor4d en forma 1, 28, 28, 1
              var tensor4 = tf.tensor4d(arr);
              var resultados = modelo.predict(tensor4).dataSync();
              var mayorIndice = resultados.indexOf(Math.max.apply(null, resultados));
              
              console.log("Prediccion", mayorIndice);
              document.getElementById("resultado").innerHTML = mayorIndice;
          }
  

          function resample_single(canvas, width, height, resize_canvas) {
              var width_source = canvas.width;
              var height_source = canvas.height;
              width = Math.round(width);
              height = Math.round(height);
  
              var ratio_w = width_source / width;
              var ratio_h = height_source / height;
              var ratio_w_half = Math.ceil(ratio_w / 2);
              var ratio_h_half = Math.ceil(ratio_h / 2);
  
              var ctx = canvas.getContext("2d");
              var ctx2 = resize_canvas.getContext("2d");
              var img = ctx.getImageData(0, 0, width_source, height_source);
              var img2 = ctx2.createImageData(width, height);
              var data = img.data;
              var data2 = img2.data;
  
              for (var j = 0; j < height; j++) {
                  for (var i = 0; i < width; i++) {
                      var x2 = (i + j * width) * 4;
                      var weight = 0;
                      var weights = 0;
                      var weights_alpha = 0;
                      var gx_r = 0;
                      var gx_g = 0;
                      var gx_b = 0;
                      var gx_a = 0;
                      var center_y = (j + 0.5) * ratio_h;
                      var yy_start = Math.floor(j * ratio_h);
                      var yy_stop = Math.ceil((j + 1) * ratio_h);
                      for (var yy = yy_start; yy < yy_stop; yy++) {
                          var dy = Math.abs(center_y - (yy + 0.5)) / ratio_h_half;
                          var center_x = (i + 0.5) * ratio_w;
                          var w0 = dy * dy; //pre-calc part of w
                          var xx_start = Math.floor(i * ratio_w);
                          var xx_stop = Math.ceil((i + 1) * ratio_w);
                          for (var xx = xx_start; xx < xx_stop; xx++) {
                              var dx = Math.abs(center_x - (xx + 0.5)) / ratio_w_half;
                              var w = Math.sqrt(w0 + dx * dx);
                              if (w >= 1) {
                                  //pixel too far
                                  continue;
                              }
                              //hermite filter
                              weight = 2 * w * w * w - 3 * w * w + 1;
                              var pos_x = 4 * (xx + yy * width_source);
                              //alpha
                              gx_a += weight * data[pos_x + 3];
                              weights_alpha += weight;
                              //colors
                              if (data[pos_x + 3] < 255)
                                  weight = weight * data[pos_x + 3] / 250;
                              gx_r += weight * data[pos_x];
                              gx_g += weight * data[pos_x + 1];
                              gx_b += weight * data[pos_x + 2];
                              weights += weight;
                          }
                      }
                      data2[x2] = gx_r / weights;
                      data2[x2 + 1] = gx_g / weights;
                      data2[x2 + 2] = gx_b / weights;
                      data2[x2 + 3] = gx_a / weights_alpha;
                  }
              }
  
              //Ya que esta, exagerarlo. Blancos blancos y negros negros..?
  
              for (var p=0; p < data2.length; p += 4) {
                  var gris = data2[p]; //Esta en blanco y negro
  
                  if (gris < 100) {
                      gris = 0; //exagerarlo
                  } else {
                      gris = 255; //al infinito
                  }
  
                  data2[p] = gris;
                  data2[p+1] = gris;
                  data2[p+2] = gris;
              }
  
  
              ctx2.putImageData(img2, 0, 0);
          }


            var modelo = null;

            (async () =>{
                console.log("Cargando modelo...");
                modelo = await tf.loadLayersModel("model.json");
                console.log("Modelo cargado ")

            })();
        </script>
        

    </body>
</HTML>